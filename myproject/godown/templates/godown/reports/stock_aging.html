{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'godown/css/godown.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">Stock Aging Report</h1>
            <p class="text-muted mb-0">Inventory age analysis as of {% now "d M, Y" %}</p>
        </div>
        <div>
            <a href="{% url 'stock_aging_image' %}" target="_blank" class="action-button">
                <i class="fas fa-download"></i> Download
            </a>
        </div>
    </div>

    <!-- Summary Metrics -->
    <div class="metric-grid mb-4">
        <!-- Total Stock -->
        <div class="metric-card metric-card--info">
            <div class="metric-card__content">
                <div class="metric-value">
                    <span class="text-muted small font-weight-bold text-uppercase">Total Stock</span>
                    <span class="metric-value__primary">{{ grand_total }}</span>
                </div>
                <div class="stat-icon text-info">
                    <i class="fas fa-boxes"></i>
                </div>
            </div>
        </div>

        <!-- Critical Stock (>90 Days) -->
        <div
            class="metric-card {% if total_90_plus > 0 %}metric-card--critical{% else %}metric-card--normal{% endif %}">
            <div class="metric-card__content">
                <div class="metric-value">
                    <span class="text-muted small font-weight-bold text-uppercase">>90 Days (Critical)</span>
                    <span class="metric-value__primary">{{ total_90_plus }}</span>
                </div>
                <div class="stat-icon {% if total_90_plus > 0 %}text-danger{% else %}text-success{% endif %}">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>

        <!-- High Alert (61-90 Days) -->
        <div class="metric-card {% if total_61_90 > 0 %}metric-card--warning{% else %}metric-card--normal{% endif %}">
            <div class="metric-card__content">
                <div class="metric-value">
                    <span class="text-muted small font-weight-bold text-uppercase">61-90 Days (Alert)</span>
                    <span class="metric-value__primary">{{ total_61_90 }}</span>
                </div>
                <div class="stat-icon {% if total_61_90 > 0 %}text-warning{% else %}text-success{% endif %}">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
        </div>

        <!-- Fresh Stock (0-30 Days) -->
        <div class="metric-card metric-card--normal">
            <div class="metric-card__content">
                <div class="metric-value">
                    <span class="text-muted small font-weight-bold text-uppercase">0-30 Days (Fresh)</span>
                    <span class="metric-value__primary">{{ total_0_30 }}</span>
                </div>
                <div class="stat-icon text-success">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Report Table -->
    <div class="widget-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">
                <i class="fas fa-table"></i> Detailed Breakdown
            </h4>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="agingTable" width="100%" cellspacing="0">
                <thead class="bg-light">
                    <tr>
                        <th class="border-0 py-3">Product</th>
                        <th class="text-center border-0 py-3">0-30 Days</th>
                        <th class="text-center border-0 py-3">31-60 Days</th>
                        <th class="text-center border-0 py-3">61-90 Days</th>
                        <th class="text-center border-0 py-3">>90 Days</th>
                        <th class="text-center border-0 py-3">Total Stock</th>
                        <th class="text-center border-0 py-3">Action Required</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in aging_data %}
                    <tr>
                        <td class="font-weight-bold py-3">{{ item.product_name }}</td>
                        <td class="text-center py-3">
                            {% if item.bucket_0_30 > 0 %}
                            <span class="badge bg-light text-dark border">{{ item.bucket_0_30 }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center py-3">
                            {% if item.bucket_31_60 > 0 %}
                            <span class="badge bg-info text-white">{{ item.bucket_31_60 }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center py-3">
                            {% if item.bucket_61_90 > 0 %}
                            <span class="badge bg-warning text-dark">{{ item.bucket_61_90 }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center py-3">
                            {% if item.bucket_90_plus > 0 %}
                            <span class="badge bg-danger text-white">{{ item.bucket_90_plus }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center font-weight-bold py-3">{{ item.total_stock }}</td>
                        <td class="text-center py-3">
                            {% if "CRITICAL" in item.action %}
                            <span class="badge bg-danger p-2"><i class="fas fa-ban mr-1"></i> {{ item.action }}</span>
                            {% elif "High Alert" in item.action %}
                            <span class="badge bg-warning text-dark p-2"><i class="fas fa-exclamation-circle mr-1"></i>
                                {{ item.action }}</span>
                            {% elif "Monitor" in item.action %}
                            <span class="badge bg-info text-white p-2"><i class="fas fa-eye mr-1"></i> {{ item.action
                                }}</span>
                            {% else %}
                            <span class="badge bg-success p-2"><i class="fas fa-check mr-1"></i> {{ item.action
                                }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-box-open fa-3x mb-3"></i>
                                <p>No active stock found.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if aging_data %}
                <tfoot class="bg-light font-weight-bold">
                    <tr>
                        <td class="py-3">TOTAL</td>
                        <td class="text-center py-3">{{ total_0_30 }}</td>
                        <td class="text-center py-3">{{ total_31_60 }}</td>
                        <td class="text-center py-3">{{ total_61_90 }}</td>
                        <td class="text-center text-danger py-3">{{ total_90_plus }}</td>
                        <td class="text-center py-3">{{ grand_total }}</td>
                        <td></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card">
        <div class="card-body">
          <h3 class="mb-4 text-primary">Update Order Details</h3>
          
          <!-- Order Summary -->
          <div class="alert alert-info mb-4">
            <h5 class="alert-heading">Order Summary</h5>
            <p class="mb-1"><strong>Order Number:</strong> {{ order.order_number }}</p>
            <p class="mb-1"><strong>Dealer:</strong> {{ order.dealer.name }} ({{ order.dealer.code }})</p>
            <p class="mb-1"><strong>Vehicle:</strong> {{ order.vehicle.truck_number }}</p>
            <p class="mb-1"><strong>Depot:</strong> {{ order.depot.name }}</p>
            <p class="mb-0"><strong>Order Date:</strong> {{ order.order_date|date:'M d, Y' }}</p>
          </div>

          <form method="post" id="updateOrderForm">
            {% csrf_token %}
            
            <div class="row">
              <!-- Left Column - Status Updates -->
              <div class="col-md-6">
                <h5 class="text-secondary mb-3">Status Updates</h5>
                
                {% if is_dealer_anonymous %}
                <div class="mb-3">
                  <label for="dealer_id" class="form-label">Change Dealer</label>
                  <select class="form-select" id="dealer_id" name="dealer_id">
                    <option value="">Keep as Anonymous</option>
                    {% for dealer in dealers %}
                    <option value="{{ dealer.id }}">{{ dealer.name }} ({{ dealer.code }})</option>
                    {% endfor %}
                  </select>
                  <div class="form-text">Current dealer is Anonymous. Select a dealer to change it.</div>
                </div>
                {% endif %}
                
                
                <div class="mb-3">
                  <label for="mrn_date" class="form-label">MRN Date</label>
                  <input type="date" class="form-control" id="mrn_date" name="mrn_date" value="{{ mrn_date|date:'Y-m-d' }}">
                </div>
                
                <div class="mb-3">
                  <label for="invoice_date" class="form-label">Invoice Date</label>
                  <input type="date" class="form-control" id="invoice_date" name="invoice_date" value="{{ invoice_date|date:'Y-m-d' }}">
                </div>
              </div>
              
              <!-- Right Column - Product Management -->
              <div class="col-md-6">
                <h5 class="text-secondary mb-3">Product Details</h5>
                
                <div id="product-items">
                  {% for item in order.order_items.all %}
                  <div class="product-item border rounded p-3 mb-3" data-product-id="{{ item.product.id }}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div>
                        <h6 class="mb-1">{{ item.product.name }}</h6>
                        <small class="text-muted">Code: {{ item.product.code }}</small>
                      </div>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-product" title="Remove Product">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                    
                    <div class="row">
                      <div class="col-12">
                        <label class="form-label">Quantity ({{ item.product.unit }})</label>
                        <input type="number" 
                               class="form-control product-quantity" 
                               name="product_{{ item.product.id }}_quantity"
                               value="{{ item.quantity }}" 
                               step="0.01" 
                               min="0.01"
                               data-original-quantity="{{ item.quantity }}">
                      </div>
                    </div>
                    
                    
                    
                    <!-- Hidden field to track existing products -->
                    <input type="hidden" name="existing_product_{{ item.product.id }}" value="1">
                  </div>
                  {% endfor %}
                </div>
                
                <!-- Add New Product Section -->
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Add New Product</h6>
                    <div class="row">
                      <div class="col-12 mb-2">
                        <select class="form-select" id="new-product-select">
                          <option value="">Select a product to add...</option>
                          {% for product in available_products %}
                          <option value="{{ product.id }}" data-name="{{ product.name }}" data-code="{{ product.code }}" data-unit="{{ product.unit }}">
                            {{ product.name }} ({{ product.code }})
                          </option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="add-product-btn" disabled>
                      <i class="fas fa-plus"></i> Add Product
                    </button>
                  </div>
                </div>
                
                <!-- Total Summary -->
                <div class="mt-3 p-3 bg-primary text-white rounded">
                  <div class="row">
                    <div class="col-6">
                      <strong>Total Quantity:</strong><br>
                      <span id="total-quantity">{{ order.get_total_quantity }}</span> MT
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <hr class="my-4">
            
            <!-- MRN Images Section -->
            <div class="row">
              <div class="col-12">
                <h5 class="text-secondary mb-3">MRN Proof Images</h5>
                
                <!-- Existing Images -->
                <div id="existing-images" class="mb-4">
                  <div class="row" id="existing-images-container">
                    <!-- Images will be loaded here via JavaScript -->
                  </div>
                </div>
                
                <!-- Upload New Images -->
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">Upload New Images</h6>
                    <div class="upload-zone border border-2 border-dashed rounded p-4 text-center" id="imageUploadZone" style="cursor: pointer; transition: all 0.3s ease;">
                      <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                      <p class="mb-2 text-muted">Drop images here or click to upload</p>
                      <input type="file" id="mrnImages" name="mrn_images" multiple accept="image/*" class="d-none">
                      <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('mrnImages').click()">
                        <i class="fas fa-plus me-1"></i>Choose Files
                      </button>
                    </div>
                    <div id="imagePreview" class="mt-3 row"></div>
                    <small class="form-text text-muted">
                      <i class="fas fa-info-circle me-1"></i>
                      Upload photos as proof that MRN has been completed. Supported formats: JPG, PNG, WEBP (Max 5MB each)
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
              <a href="{% url 'order_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancel
              </a>
              <button type="submit" class="btn btn-primary" id="update-btn">
                <i class="fas fa-save"></i> Update Order
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Product Item Template (hidden) -->
<template id="product-item-template">
  <div class="product-item border rounded p-3 mb-3" data-product-id="">
    <div class="d-flex justify-content-between align-items-start mb-2">
      <div>
        <h6 class="mb-1 product-name"></h6>
        <small class="text-muted">Code: <span class="product-code"></span></small>
      </div>
      <button type="button" class="btn btn-sm btn-outline-danger remove-product" title="Remove Product">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="row">
      <div class="col-12">
        <label class="form-label">Quantity (<span class="product-unit"></span>)</label>
        <input type="number" 
               class="form-control product-quantity" 
               name=""
               value="1" 
               step="0.01" 
               min="0.01">
      </div>
    </div>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent form submission on Enter key press
    document.getElementById('updateOrderForm').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.type !== 'submit') {
            e.preventDefault();
            return false;
        }
    });
    
    // Product management functionality
    const productItemsContainer = document.getElementById('product-items');
    const newProductSelect = document.getElementById('new-product-select');
    const addProductBtn = document.getElementById('add-product-btn');
    const updateBtn = document.getElementById('update-btn');
    
    // Enable/disable add product button
    newProductSelect.addEventListener('change', function() {
        addProductBtn.disabled = !this.value;
    });
    
    // Add new product
    addProductBtn.addEventListener('click', function() {
        const selectedOption = newProductSelect.options[newProductSelect.selectedIndex];
        if (!selectedOption.value) return;
        
        const productId = selectedOption.value;
        const productName = selectedOption.dataset.name;
        const productCode = selectedOption.dataset.code;
        const productUnit = selectedOption.dataset.unit;
        
        // Check if product already exists
        if (document.querySelector(`[data-product-id="${productId}"]`)) {
            alert('This product is already added to the order.');
            return;
        }
        
        // Clone template
        const template = document.getElementById('product-item-template');
        const clone = template.content.cloneNode(true);
        
        // Fill in product details
        const productItem = clone.querySelector('.product-item');
        productItem.setAttribute('data-product-id', productId);
        
        clone.querySelector('.product-name').textContent = productName;
        clone.querySelector('.product-code').textContent = productCode;
        clone.querySelector('.product-unit').textContent = productUnit;
        
        // Set input names
        clone.querySelector('.product-quantity').name = `product_${productId}_quantity`;
        
        // Add to container
        productItemsContainer.appendChild(clone);
        
        // Reset select
        newProductSelect.value = '';
        addProductBtn.disabled = true;
        
        // Update totals
        updateTotals();
        
        // Remove product from available options
        selectedOption.style.display = 'none';
    });
    
    // Remove product functionality
    productItemsContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-product')) {
            const productItem = e.target.closest('.product-item');
            const productId = productItem.getAttribute('data-product-id');
            
            // Show confirmation
            if (confirm('Are you sure you want to remove this product from the order?')) {
                productItem.remove();
                
                // Re-enable in select dropdown
                const option = newProductSelect.querySelector(`option[value="${productId}"]`);
                if (option) {
                    option.style.display = '';
                }
                
                updateTotals();
            }
        }
    });
    
    // Update totals when quantity changes
    productItemsContainer.addEventListener('input', function(e) {
        if (e.target.classList.contains('product-quantity')) {
            updateTotals();
        }
    });
    
    
    // Function to update overall totals
    function updateTotals() {
        let totalQuantity = 0;
        
        const productItems = productItemsContainer.querySelectorAll('.product-item');
        productItems.forEach(function(item) {
            const quantity = parseFloat(item.querySelector('.product-quantity').value) || 0;
            totalQuantity += quantity;
        });
        
        document.getElementById('total-quantity').textContent = totalQuantity.toFixed(2);
    }
    
    // Initial calculation of totals
    updateTotals();
    
    // Form submission validation
    document.getElementById('updateOrderForm').addEventListener('submit', function(e) {
        const productItems = productItemsContainer.querySelectorAll('.product-item');
        let hasValidProducts = false;
        
        productItems.forEach(function(item) {
            const quantity = parseFloat(item.querySelector('.product-quantity').value) || 0;
            if (quantity > 0) {
                hasValidProducts = true;
            }
        });
        
        if (!hasValidProducts) {
            e.preventDefault();
            alert('Please ensure at least one product has a quantity greater than 0.');
            return false;
        }
        
        // Add loading state
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    });
    
    // Hide already added products from dropdown
    const existingProductIds = [];
    productItemsContainer.querySelectorAll('[data-product-id]').forEach(function(item) {
        const productId = item.getAttribute('data-product-id');
        existingProductIds.push(productId);
    });
    
    existingProductIds.forEach(function(productId) {
        const option = newProductSelect.querySelector(`option[value="${productId}"]`);
        if (option) {
            option.style.display = 'none';
        }
    });
    
    // MRN Images Management
    let selectedFiles = [];
    const uploadZone = document.getElementById('imageUploadZone');
    const fileInput = document.getElementById('mrnImages');
    const previewContainer = document.getElementById('imagePreview');
    const existingImagesContainer = document.getElementById('existing-images-container');
    
    // Get order ID from the URL or data attribute
    const orderId = '{{ order.id }}';
    
    // Load existing images
    loadExistingImages();
    
    function loadExistingImages() {
        fetch(`/api/v1/orders/${orderId}/mrn_images/`, {
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(images => {
            displayExistingImages(images);
        })
        .catch(error => {
            console.error('Error loading images:', error);
        });
    }
    
    function displayExistingImages(images) {
        existingImagesContainer.innerHTML = '';
        
        if (images.length === 0) {
            existingImagesContainer.innerHTML = '<div class="col-12"><p class="text-muted">No images uploaded yet.</p></div>';
            return;
        }
        
        images.forEach(image => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'col-md-3 col-sm-4 col-6 mb-3';
            imageDiv.innerHTML = `
                <div class="card">
                    <img src="${image.secure_image_url || image.image_url}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="MRN Proof">
                    <div class="card-body p-2">
                        <p class="card-text small mb-2">${image.original_filename}</p>
                        <span class="badge ${image.is_primary ? 'bg-success' : 'bg-secondary'} mb-2">
                            ${image.is_primary ? 'Primary' : image.image_type.replace('_', ' ')}
                        </span>
                        <div class="btn-group w-100" role="group">
                            ${!image.is_primary ? `<button type="button" class="btn btn-outline-primary btn-sm" onclick="setPrimaryImage(${image.id})">Set Primary</button>` : ''}
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteImage(${image.id})">Delete</button>
                        </div>
                        <small class="text-muted d-block mt-1">
                            Uploaded: ${new Date(image.upload_timestamp).toLocaleDateString()}
                        </small>
                    </div>
                </div>
            `;
            existingImagesContainer.appendChild(imageDiv);
        });
    }
    
    // Make functions global
    window.setPrimaryImage = function(imageId) {
        fetch(`/api/v1/mrn-images/${imageId}/set_primary/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                loadExistingImages(); // Reload to update the display
                alert('Primary image updated successfully!');
            }
        })
        .catch(error => {
            console.error('Error setting primary image:', error);
            alert('Error setting primary image');
        });
    };
    
    window.deleteImage = function(imageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/api/v1/mrn-images/${imageId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    loadExistingImages(); // Reload to update the display
                    alert('Image deleted successfully!');
                } else {
                    throw new Error('Failed to delete image');
                }
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                alert('Error deleting image');
            });
        }
    };
    
    // Drag and drop handlers for new uploads
    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });
    
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('border-primary', 'bg-primary-subtle');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('border-primary', 'bg-primary-subtle');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('border-primary', 'bg-primary-subtle');
        
        const files = Array.from(e.dataTransfer.files);
        handleFiles(files);
    });
    
    fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        handleFiles(files);
    });
    
    function handleFiles(files) {
        files.forEach(file => {
            if (validateFile(file)) {
                selectedFiles.push(file);
                addImagePreview(file);
            }
        });
    }
    
    function validateFile(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert(`Invalid file type: ${file.name}. Only JPG, PNG, and WEBP files are allowed.`);
            return false;
        }
        
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            alert(`File too large: ${file.name}. Maximum size is 5MB.`);
            return false;
        }
        
        return true;
    }
    
    function addImagePreview(file) {
        const fileIndex = selectedFiles.length - 1;
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'col-md-3 col-sm-4 col-6 mb-3';
            previewDiv.innerHTML = `
                <div class="card">
                    <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="Preview">
                    <div class="card-body p-2">
                        <p class="card-text small mb-2">${file.name}</p>
                        <div class="mb-2">
                            <select class="form-select form-select-sm image-type-select" data-index="${fileIndex}">
                                <option value="MRN_PROOF">MRN Proof</option>
                                <option value="DELIVERY_RECEIPT">Delivery Receipt</option>
                                <option value="QUALITY_CHECK">Quality Check</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-success btn-sm" onclick="uploadSingleImage(${fileIndex})">Upload</button>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeNewImage(${fileIndex})">Remove</button>
                        </div>
                    </div>
                </div>
            `;
            previewContainer.appendChild(previewDiv);
        };
        
        reader.readAsDataURL(file);
    }
    
    window.uploadSingleImage = function(index) {
        const file = selectedFiles[index];
        if (!file) return;
        
        const imageType = document.querySelector(`.image-type-select[data-index="${index}"]`).value || 'MRN_PROOF';
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('image_type', imageType);
        formData.append('description', `MRN proof image - ${file.name}`);
        
        fetch(`/api/v1/orders/${orderId}/upload_mrn_image/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                selectedFiles.splice(index, 1);
                updateNewImagePreviews();
                loadExistingImages();
                alert('Image uploaded successfully!');
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Error uploading image:', error);
            alert('Error uploading image: ' + error.message);
        });
    };
    
    window.removeNewImage = function(index) {
        selectedFiles.splice(index, 1);
        updateNewImagePreviews();
    };
    
    function updateNewImagePreviews() {
        previewContainer.innerHTML = '';
        selectedFiles.forEach((file, index) => {
            addImagePreview(file);
        });
    }
});
</script>
{% endblock %}

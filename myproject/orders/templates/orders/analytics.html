{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary"><i class="fas fa-book"></i> Order Register</h2>
  <p class="text-muted mb-4">Generate physical register for record-keeping</p>

  <!-- Date Range Selection Form -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Select Date Range</h5>
    </div>
    <div class="card-body">
      <form id="registerForm" method="get">
        <div class="row align-items-end">
          <div class="col-md-3 mb-2">
            <label for="start_date">Start Date</label>
            <input type="date" class="form-control" id="start_date" name="start_date"
                   value="{{ request.GET.start_date }}" required>
          </div>
          <div class="col-md-3 mb-2">
            <label for="end_date">End Date</label>
            <input type="date" class="form-control" id="end_date" name="end_date"
                   value="{{ request.GET.end_date }}" required>
          </div>
          <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-secondary w-100">
              <i class="fas fa-eye"></i> Preview
            </button>
          </div>
          <div class="col-md-2 mb-2">
            <button type="submit" class="btn btn-primary w-100"
                    formaction="{% url 'export_analytics' %}" formtarget="_blank">
              <i class="fas fa-print"></i> Print Register
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Date Range Buttons -->
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="mb-3">Quick Select:</h6>
      <div class="row">
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('today')">
            Today
          </button>
        </div>
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('yesterday')">
            Yesterday
          </button>
        </div>
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('this_week')">
            This Week
          </button>
        </div>
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('last_week')">
            Last Week
          </button>
        </div>
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('this_month')">
            This Month
          </button>
        </div>
        <div class="col-md-2 mb-2">
          <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="setDateRange('last_month')">
            Last Month
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Table -->
  {% if orders %}
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-table"></i> Order Register Preview
        <span class="badge badge-primary ml-2">{{ orders|length }} orders</span>
      </h5>
      <small class="text-muted">
        From {{ start_date|date:"d M Y" }} to {{ end_date|date:"d M Y" }}
      </small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="thead-light">
            <tr>
              <th width="8%">S.No.</th>
              <th width="12%">Order Date</th>
              <th width="15%">Truck Number</th>
              <th width="20%">Product</th>
              <th width="10%">Qty (MT)</th>
              <th width="15%">Dealer Name</th>
              <th width="10%">MRN Date</th>
              <th width="10%">Billing Date</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ order.order_date|date:"d-m-Y" }}</td>
              <td>{{ order.vehicle.truck_number }}</td>
              <td>
                {% for item in order.order_items.all %}
                  {{ item.product.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
              </td>
              <td>{{ order.get_total_quantity|floatformat:2 }}</td>
              <td>
                {% if order.dealer.name|lower != "anonymous" and order.depot.name != "Unknown Depot" %}
                  {{ order.dealer.name }}
                {% else %}
                  <span class="text-muted">_____________</span>
                {% endif %}
              </td>
              <td>
                {% if order.mrn_date %}
                  {{ order.mrn_date|date:"d-m-Y" }}
                {% else %}
                  <span class="text-muted">_____________</span>
                {% endif %}
              </td>
              <td>
                {% if order.bill_date %}
                  {{ order.bill_date|date:"d-m-Y" }}
                {% else %}
                  <span class="text-muted">_____________</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% elif request.GET.start_date %}
  <div class="card">
    <div class="card-body text-center">
      <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
      <h5>No Orders Found</h5>
      <p class="text-muted">No orders were found in the selected date range.</p>
    </div>
  </div>
  {% else %}
  <div class="card">
    <div class="card-body text-center">
      <i class="fas fa-calendar-alt fa-3x text-primary mb-3"></i>
      <h5>Select Date Range</h5>
      <p class="text-muted">Please select a date range above to preview the order register.</p>
    </div>
  </div>
  {% endif %}
</div>

<script>
function setDateRange(period) {
  const today = new Date();
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');

  let startDate, endDate;

  switch(period) {
    case 'today':
      startDate = endDate = today;
      break;
    case 'yesterday':
      startDate = endDate = new Date(today);
      startDate.setDate(today.getDate() - 1);
      endDate = startDate;
      break;
    case 'this_week':
      startDate = new Date(today);
      startDate.setDate(today.getDate() - today.getDay());
      endDate = today;
      break;
    case 'last_week':
      startDate = new Date(today);
      startDate.setDate(today.getDate() - today.getDay() - 7);
      endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      break;
    case 'this_month':
      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
      endDate = today;
      break;
    case 'last_month':
      startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      endDate = new Date(today.getFullYear(), today.getMonth(), 0);
      break;
  }

  startDateInput.value = startDate.toISOString().split('T')[0];
  endDateInput.value = endDate.toISOString().split('T')[0];
}
</script>
{% endblock %}

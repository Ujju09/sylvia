{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shyam Distributors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'orders/theme.css' %}?v=3.0">
    {% block extra_css %}{% endblock %}
    {% comment %} Add favicon {% endcomment %}
    <link rel="icon" href="{% static 'orders/favicon.ico' %}" type="image/x-icon">
    <script>
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Re Cs Fs Pe Rs Ms capture Ve calculateEventProperties Ds register register_once register_for_session unregister unregister_for_session zs getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty js As createPersonProfile Ns Is Us opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing Os debug I Ls getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init('phc_jJVbeMqlkWljHrsPB115Ht0V8JDeBqR5JACnu3cyqVm', {
        api_host: 'https://us.i.posthog.com',
        defaults: '2025-05-24',
        person_profiles: 'identified_only', // or 'always' to create profiles for anonymous users as well
    })
</script>
</head>
<body>
    {% if user.is_authenticated %}
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-brand d-flex align-items-center">
          <img src="{% static 'orders/logo.png' %}" alt="Logo" class="sidebar-logo">
          <span class="sidebar-brand-text">Shyam Distributors</span>
        </a>
        <button class="sidebar-collapse-btn d-none d-lg-block" id="sidebarCollapseBtn" title="Collapse sidebar">
          <i class="fas fa-angles-left"></i>
        </button>
      </div>

      {% comment %}
        nav_allowed: helper that returns True when a nav item should be shown.
        Rule: if user_organization.allowed_nav_items is empty → show all items.
              Otherwise → show only items whose key appears in the list.
        We simulate this with a boolean assignment inside each block using the
        `with` tag to avoid repeating the condition.
      {% endcomment %}
      {% with nav=user_organization.allowed_nav_items %}
      <div class="sidebar-menu">
        <ul class="nav flex-column">

          {% if not nav or 'home' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="/" data-tooltip="Home">
              <i class="fas fa-home"></i>
              <span>Home</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'intelligence' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if '/orders/dispatch-table/' in request.path %}active{% endif %}" href="/orders/dispatch-table/" data-tooltip="Intelligence">
              <i class="fas fa-robot"></i>
              <span>Intelligence</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'partnerships' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/orders/orders/' %}active{% endif %}" href="/orders/orders/" data-tooltip="Partnerships">
              <i class="fas fa-list"></i>
              <span>Partnerships</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'insights' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/orders/analytics/' %}active{% endif %}" href="/orders/analytics/" data-tooltip="Insights">
              <i class="fas fa-chart-bar"></i>
              <span>Insights</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'begin_journey' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if request.path == '/orders/order-workflow/' %}active{% endif %}" href="/orders/order-workflow/" data-tooltip="Begin Journey">
              <i class="fas fa-plus-circle"></i>
              <span>Begin Journey</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'fleet_drivers' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if '/orders/vehicles/' in request.path %}active{% endif %}" href="/orders/vehicles/" data-tooltip="Fleet & Drivers">
              <i class="fas fa-truck"></i>
              <span>Fleet & Drivers</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'partners' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if '/orders/dealers/' in request.path %}active{% endif %}" href="/orders/dealers/" data-tooltip="Partners">
              <i class="fas fa-handshake"></i>
              <span>Partners</span>
            </a>
          </li>
          {% endif %}

          {% if not nav or 'warehouse' in nav %}
          <li class="nav-item">
            <a class="nav-link {% if '/godown/' in request.path %}active{% endif %}" href="/godown/" data-tooltip="Warehouse">
              <i class="fas fa-warehouse"></i>
              <span>Warehouse</span>
            </a>
          </li>
          {% endif %}

        </ul>
      </div>
      {% endwith %}

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">
            {{ user.get_full_name|default:user.username|slice:":1"|upper }}
          </div>
          <div class="user-details">
            <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
            {% if user_organization %}
              <div class="user-org">{{ user_organization.name }}</div>
            {% endif %}
          </div>
        </div>
        <div class="user-actions">
          <a href="{% url 'organization_detail' %}" class="user-action-btn" title="Organization">
            <i class="fas fa-building"></i>
          </a>
          <a href="/logout/" class="user-action-btn" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Mobile Top Bar -->
    <div class="mobile-topbar d-lg-none">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <a href="/" class="mobile-brand">
        <img src="{% static 'orders/logo.png' %}" alt="Logo" class="mobile-logo">
        <span>Shyam Distributors</span>
      </a>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content {% if not user.is_authenticated %}no-sidebar{% endif %}">
      {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'orders/order_workflow.js' %}"></script>
    <script>
      // Sidebar toggle for mobile and collapse for desktop
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
        const mainContent = document.querySelector('.main-content');

        // Mobile toggle
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            sidebarOverlay.classList.toggle('show');
          });
        }

        if (sidebarOverlay) {
          sidebarOverlay.addEventListener('click', function() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
          });
        }

        // Desktop collapse/expand
        if (sidebarCollapseBtn) {
          // Check localStorage for saved state
          const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
          if (isCollapsed) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
          }

          sidebarCollapseBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');

            // Save state to localStorage
            const collapsed = sidebar.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', collapsed);

            // Update icon
            const icon = this.querySelector('i');
            if (collapsed) {
              icon.classList.remove('fa-angles-left');
              icon.classList.add('fa-angles-right');
            } else {
              icon.classList.remove('fa-angles-right');
              icon.classList.add('fa-angles-left');
            }
          });

          // Set initial icon state
          if (isCollapsed) {
            const icon = sidebarCollapseBtn.querySelector('i');
            icon.classList.remove('fa-angles-left');
            icon.classList.add('fa-angles-right');
          }
        }
      });
    </script>
</body>
</html>
